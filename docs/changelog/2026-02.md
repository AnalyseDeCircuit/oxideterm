# OxideTerm å˜æ›´æ—¥å¿— - 2026å¹´2æœˆ

## 2026-02-05: ç«¯å£è½¬å‘å†…å­˜å®‰å…¨å¢å¼º (v1.4.3)

### ğŸ”§ æ¶æ„é‡æ„

#### æ— é” Channel I/O æ¶æ„

é‡æ„äº† `local.rs`ã€`remote.rs`ã€`dynamic.rs` ä¸­çš„æ•°æ®æ¡¥æ¥é€»è¾‘ï¼Œä» `Arc<Mutex<Channel>>` å‡çº§ä¸ºæ¶ˆæ¯ä¼ é€’æ¨¡å¼ï¼š

**é—®é¢˜èƒŒæ™¯**
- æ—§æ¶æ„ä¸­ï¼Œè¯»å†™ä»»åŠ¡ç«äº‰åŒä¸€ä¸ª Mutex é”
- æŒé”è°ƒç”¨ `.await` å¯èƒ½å¯¼è‡´å…¶ä»–ä»»åŠ¡é•¿æ—¶é—´ç­‰å¾…
- æŸäº›è¾¹ç¼˜æƒ…å†µä¸‹å­˜åœ¨æ­»é”é£é™©

**æ–°æ¶æ„**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  handle_forward_connection                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   mpsc    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ local_readerâ”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚   ssh_io                    â”‚  â”‚
â”‚  â”‚ (æ— é”è¯»)    â”‚           â”‚   (å•ç‹¬æŒæœ‰ Channel,        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚    æ— éœ€ Mutex)              â”‚  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   mpsc    â”‚                             â”‚  â”‚
â”‚  â”‚ local_writerâ”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                             â”‚  â”‚
â”‚  â”‚ (æ— é”å†™)    â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                            â”‚
â”‚  shutdown_rx â† æ¥è‡ªä¸»ä»»åŠ¡çš„ broadcast ä¿¡å·                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…³é”®æ”¹è¿›**
| æ”¹è¿›é¡¹ | è¯´æ˜ |
|--------|------|
| **Channel å•æ‰€æœ‰æƒ** | SSH Channel ç”± `ssh_io` ä»»åŠ¡ç‹¬å æŒæœ‰ï¼Œæ— éœ€ Mutex |
| **mpsc è§£è€¦** | è¯»å†™ä»»åŠ¡é€šè¿‡ `mpsc::channel` ä¸ SSH I/O ä»»åŠ¡é€šä¿¡ |
| **ä¿¡å·ä¼ æ’­** | å­è¿æ¥ä»»åŠ¡è®¢é˜… `shutdown_rx`ï¼ŒSSH æ–­å¼€æ—¶ä¸»åŠ¨é€€å‡º |
| **å…¨é“¾è·¯è¶…æ—¶** | æ‰€æœ‰ I/O æ“ä½œéƒ½æœ‰ `IDLE_TIMEOUT` (300s) ä¿æŠ¤ |

#### å­ä»»åŠ¡ Shutdown ä¿¡å·ä¼ æ’­

ä¿®å¤äº†å­è¿æ¥ä»»åŠ¡ï¼ˆæ¯ä¸ª accept çš„ TCP è¿æ¥ï¼‰æœªç›‘å¬ SSH æ–­å¼€ä¿¡å·çš„é—®é¢˜ï¼š

```rust
// ä¸»ä»»åŠ¡åˆ›å»º broadcast é€šé“
let (child_shutdown_tx, _) = broadcast::channel::<()>(16);

// æ¯ä¸ªå­ä»»åŠ¡è®¢é˜… shutdown ä¿¡å·
let mut child_shutdown_rx = child_shutdown_tx.subscribe();

// å­ä»»åŠ¡å†…éƒ¨ç›‘å¬
tokio::select! {
    _ = shutdown_rx.recv() => {
        debug!("Received shutdown signal");
        break;
    }
    // ... å…¶ä»– I/O æ“ä½œ
}
```

#### remote.rs è¶…æ—¶ä¿æŠ¤

ä¸º `bridge_forwarded_connection` æ·»åŠ äº†ç¼ºå¤±çš„ `REMOTE_FORWARD_IDLE_TIMEOUT` (300s)ï¼š

```rust
// æ‰€æœ‰ I/O éƒ½æœ‰è¶…æ—¶ä¿æŠ¤
match tokio::time::timeout(REMOTE_FORWARD_IDLE_TIMEOUT, channel.wait()).await {
    Err(_) => {
        debug!("idle timeout, closing connection");
        break;
    }
    // ...
}
```

### ğŸ“š æ–‡æ¡£æ›´æ–°

- `docs/PORT_FORWARDING.md`ï¼šæ›´æ–°è‡³ v1.4.2ï¼Œæ–°å¢æ— é”æ¶æ„ç« èŠ‚
- `README.md` / `README.zh-CN.md` / `README.fr.md`ï¼šæ›´æ–°ç«¯å£è½¬å‘ç‰¹æ€§æè¿°

### ğŸ§¹ ä»£ç æ¸…ç†

ç§»é™¤å¼ƒç”¨çš„ Tauri å‘½ä»¤æ³¨å†Œï¼š
- `connect_v2` â†’ ä½¿ç”¨ `connect_tree_node` + `expand_manual_preset`
- `ssh_connect` â†’ ä½¿ç”¨ `connect_tree_node`

ä¿®å¤ clippy è­¦å‘Šï¼š
- `cert_path` é‡å‘½åä¸º `_cert_path`ï¼ˆæœªä½¿ç”¨å˜é‡ï¼‰
- `ExitReason::Error` æ·»åŠ  `#[allow(dead_code)]` æ³¨è§£

---

## 2026-02-05: AI èŠå¤©æŒä¹…åŒ–åç«¯ (v1.4.2)

### âœ¨ æ–°ç‰¹æ€§

#### AI å¯¹è¯ redb æŒä¹…åŒ–å­˜å‚¨

ä½¿ç”¨ Rust redb åµŒå…¥å¼æ•°æ®åº“æ›¿ä»£ localStorageï¼Œå®ç°é«˜æ€§èƒ½å¯¹è¯æŒä¹…åŒ–ï¼š

**å­˜å‚¨æ¶æ„**
```
~/.config/oxideterm/
â”œâ”€â”€ state.redb            # ä¼šè¯ã€è½¬å‘ã€è®¾ç½®
â””â”€â”€ chat_history.redb     # AI å¯¹è¯ (NEW)
```

**æ•°æ®è¡¨è®¾è®¡**

| è¡¨å | é”® | å€¼ |
|------|-----|-----|
| `conversations` | conversation_id | ConversationMeta (msgpack) |
| `messages` | message_id | PersistedMessage (msgpack) |
| `conversation_messages` | conversation_id | Vec<message_id> |
| `ai_chat_metadata` | key | value |

**æ ¸å¿ƒç‰¹æ€§**
- **zstd å‹ç¼©**ï¼šç¼“å†²åŒºå¿«ç…§ >4KB è‡ªåŠ¨å‹ç¼© (~5x å‹ç¼©ç‡)
- **LRU é©±é€**ï¼šæœ€å¤š 100 ä¸ªå¯¹è¯ï¼Œè¶…é™è‡ªåŠ¨åˆ é™¤æœ€æ—§
- **æ¶ˆæ¯é™åˆ¶**ï¼šæ¯å¯¹è¯æœ€å¤š 200 æ¡æ¶ˆæ¯
- **æ‡’åŠ è½½**ï¼šåˆå§‹ä»…åŠ è½½å¯¹è¯åˆ—è¡¨ï¼Œæ¶ˆæ¯æŒ‰éœ€åŠ è½½
- **ä¸Šä¸‹æ–‡å¿«ç…§**ï¼šæ¯æ¡æ¶ˆæ¯å…³è”å®Œæ•´çš„ç»ˆç«¯ä¸Šä¸‹æ–‡

**Tauri Commands**

| å‘½ä»¤ | åŠŸèƒ½ |
|------|------|
| `ai_chat_list_conversations` | åˆ—å‡ºå¯¹è¯ (ä»…å…ƒæ•°æ®) |
| `ai_chat_get_conversation` | è·å–å®Œæ•´å¯¹è¯å«æ¶ˆæ¯ |
| `ai_chat_create_conversation` | åˆ›å»ºæ–°å¯¹è¯ |
| `ai_chat_update_conversation` | æ›´æ–°å¯¹è¯å…ƒæ•°æ® |
| `ai_chat_delete_conversation` | åˆ é™¤å¯¹è¯ |
| `ai_chat_save_message` | ä¿å­˜æ¶ˆæ¯ (å«ä¸Šä¸‹æ–‡å¿«ç…§) |
| `ai_chat_update_message` | æ›´æ–°æ¶ˆæ¯å†…å®¹ (æµå¼) |
| `ai_chat_delete_messages_after` | åˆ é™¤æŒ‡å®šæ¶ˆæ¯åå†…å®¹ (é‡æ–°ç”Ÿæˆ) |
| `ai_chat_clear_all` | æ¸…ç©ºæ‰€æœ‰å¯¹è¯ |
| `ai_chat_get_stats` | è·å–æ•°æ®åº“ç»Ÿè®¡ |

#### æ–°å¢æ¨¡å—

| æ–‡ä»¶ | åŠŸèƒ½ |
|------|------|
| `src-tauri/src/state/ai_chat.rs` | AI èŠå¤© redb å­˜å‚¨å±‚ (~600 è¡Œ) |
| `src-tauri/src/commands/ai_chat.rs` | Tauri å‘½ä»¤å±‚ (~300 è¡Œ) |

#### æ–°å¢ä¾èµ–

- `zstd = "0.13"` - é«˜æ€§èƒ½å‹ç¼©

### ğŸ“š æ–‡æ¡£æ›´æ–°

- `docs/AI_SIDEBAR_CHAT.md`ï¼šæ–°å¢æŒä¹…åŒ–æ¶æ„è¯´æ˜

---

## 2026-02-05: AI ä¸Šä¸‹æ–‡æ³¨å…¥å¢å¼º (v1.4.1)

### âœ¨ æ–°ç‰¹æ€§

#### ä¾§è¾¹æ æ·±åº¦ä¸Šä¸‹æ–‡æ„ŸçŸ¥

å®ç°ç±»ä¼¼ GitHub Copilot çš„æ™ºèƒ½ä¸Šä¸‹æ–‡æ³¨å…¥ï¼ŒAI åŠ©æ‰‹ç°åœ¨è‡ªåŠ¨æ„ŸçŸ¥ï¼š

**1. ç¯å¢ƒå¿«ç…§ (Environment Snapshot)**
- æœ¬åœ° OS æ£€æµ‹ (macOS/Windows/Linux)
- ç»ˆç«¯ç±»å‹è¯†åˆ« (SSH/Local)
- SSH è¿æ¥è¯¦æƒ… (`user@host`)
- è¿œç¨‹ OS æ¨æµ‹ (åŸºäºä¸»æœºåæ¨¡å¼)

**2. åŠ¨æ€ç¼“å†²åŒºåŒæ­¥ (Buffer Sync)**
- è‡ªåŠ¨æ•è·ç»ˆç«¯æœ€å 50 è¡Œè¾“å‡º
- å¯é…ç½®çš„å­—ç¬¦é™åˆ¶ (é»˜è®¤ 8000 å­—ç¬¦)
- æ— éœ€æ‰‹åŠ¨ç‚¹å‡» "Include context"

**3. é€‰åŒºä¼˜å…ˆçº§ (Selection Priority)**
- ç»ˆç«¯é€‰ä¸­æ–‡æœ¬ä½œä¸º "é‡ç‚¹åˆ†æå¯¹è±¡"
- AI è‡ªåŠ¨å°†é€‰åŒºè§†ä¸ºæŸ¥è¯¢ä¸»é¢˜
- å®Œç¾é€‚é…é”™è¯¯è¯Šæ–­åœºæ™¯

#### æ–°å¢æ¨¡å—

| æ–‡ä»¶ | åŠŸèƒ½ |
|------|------|
| `src/lib/sidebarContextProvider.ts` | ç¯å¢ƒä¸Šä¸‹æ–‡èšåˆå™¨ |

#### terminalRegistry é€‰åŒºæ”¯æŒ

æ‰©å±• `terminalRegistry.ts` æ”¯æŒé€‰åŒºè·å–ï¼š

```typescript
// æ–°å¢ API
export function getActiveTerminalSelection(): string | null;
export function getTerminalSelection(paneId: string): string | null;
export function updateSelectionGetter(paneId, getter): void;

// æ³¨å†Œæ—¶æ”¯æŒå¯é€‰çš„é€‰åŒºè·å–å‡½æ•°
registerTerminalBuffer(paneId, tabId, sessionId, type, bufferGetter, selectionGetter?);
```

#### å†…è” AI VS Code é£æ ¼é‡æ„

- **è§†è§‰æ›´æ–°**ï¼šæ— é®ç½©ã€é˜´å½±è¾¹æ¡†ã€520px å›ºå®šå®½åº¦
- **å…‰æ ‡å®šä½**ï¼šé¢æ¿è·Ÿéšç»ˆç«¯å…‰æ ‡ä½ç½®
- **æ–°å¿«æ·é”®**ï¼šEnter=å‘é€/æ‰§è¡Œï¼ŒTab=æ’å…¥ï¼ŒEsc=å…³é—­
- **åŠ è½½åŠ¨ç”»**ï¼šè“è‰²å¾®å…‰æ¡æŒ‡ç¤ºç”Ÿæˆä¸­

### ğŸ“š æ–‡æ¡£æ›´æ–°

- `docs/AI_SIDEBAR_CHAT.md`ï¼šæ–°å¢ä¸Šä¸‹æ–‡æ³¨å…¥æ¶æ„è¯´æ˜
- `docs/AI_INLINE_CHAT.md`ï¼šæ›´æ–° VS Code é£æ ¼ç•Œé¢è¯´æ˜

---

## 2026-02-04: è¿æ¥æ¶æ„ä¿®å¤ (v1.4.0)

### ğŸ› Bug ä¿®å¤

#### Store é—´åŒæ­¥ç¼ºå¤±å¯¼è‡´ `connectionState=undefined` æ­»é”

**é—®é¢˜ç°è±¡**ï¼š
- SSH é‡è¿æˆåŠŸåï¼ŒSFTPView å’Œ TransferQueue å¡åœ¨ "Waiting for connection"
- æ§åˆ¶å°æ˜¾ç¤º `connectionState=undefined, isConnectionReady=false`
- StateDrift æ—¥å¿—æ˜¾ç¤º `Auto-fixed 1 drift(s)` ä½† UI æ— ååº”

**æ ¹æœ¬åŸå› **ï¼š
`sessionTreeStore.connectNodeInternal()` å’Œ `syncDrift()` åªæ›´æ–° `rawNodes`ï¼Œ
ä¸åŒæ­¥ `appStore.connections`ï¼Œè€Œ SFTPView/TransferQueue ä¾èµ–åè€…åˆ¤æ–­è¿æ¥çŠ¶æ€ã€‚

```
æ—§æ•°æ®æµï¼ˆæ–­è£‚ï¼‰:
  [Backend] SSH Connected
    â†’ [sessionTreeStore] rawNodes æ›´æ–° âœ…
    â†’ [appStore] connections Map æœªæ›´æ–° âŒ
    â†’ [SFTPView] connectionState = undefined â†’ å¡æ­» ğŸ’€
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
åœ¨ä»¥ä¸‹ä½ç½®æ·»åŠ  `await useAppStore.getState().refreshConnections()`ï¼š

| æ–‡ä»¶ | ä½ç½® | è§¦å‘æ—¶æœº |
|------|------|----------|
| `sessionTreeStore.ts` | `connectNodeInternal()` | SSH è¿æ¥å»ºç«‹æˆåŠŸå |
| `sessionTreeStore.ts` | `syncDrift()` | StateDrift è‡ªåŠ¨ä¿®å¤å |

```
æ–°æ•°æ®æµï¼ˆå®Œæ•´ï¼‰:
  [Backend] SSH Connected
    â†’ [sessionTreeStore] rawNodes æ›´æ–°
    â†’ [refreshConnections()] appStore.connections åŒæ­¥
    â†’ [SFTPView] connectionState = 'active' â†’ æ­£å¸¸åˆå§‹åŒ– âœ…
```

**å½±å“èŒƒå›´**ï¼š
- SFTPView
- TransferQueue
- ForwardsView
- IdeWorkspace

---

### âœ¨ æ–°ç‰¹æ€§

#### Key-Driven Reset æ¨¡å¼

ä¸ºè§£å†³é‡è¿åç»„ä»¶æŒæœ‰è¿‡æœŸçŠ¶æ€çš„é—®é¢˜ï¼Œåœ¨ `AppLayout.tsx` ä¸­å®ç°å¤åˆ Keyï¼š

```tsx
// å½“ connectionId å˜åŒ–æ—¶ï¼ŒReact è‡ªåŠ¨é”€æ¯æ—§ç»„ä»¶ã€åˆ›å»ºæ–°å®ä¾‹
<SFTPView 
  key={`sftp-${tab.sessionId}-${getSession(tab.sessionId)?.connectionId ?? ''}`}
  sessionId={tab.sessionId} 
/>
```

é€‚ç”¨ç»„ä»¶ï¼š
- `SFTPView`
- `ForwardsView`
- `IdeWorkspace`

#### SFTP è·¯å¾„è®°å¿†

è·¨é‡è¿ä¿æŒç”¨æˆ·ç›®å½•ä½ç½®ï¼š

```typescript
// å…¨å±€ Mapï¼ˆæ¨¡å—é¡¶å±‚ï¼‰
const sftpPathMemory = new Map<string, string>();

// ç»„ä»¶æŒ‚è½½æ—¶æ¢å¤
const savedPath = sftpPathMemory.get(sessionId);

// è·¯å¾„å˜åŒ–æ—¶ä¿å­˜
sftpPathMemory.set(sessionId, remotePath);
```

#### TransferQueue çŠ¶æ€é—¨ç¦

è¿æ¥æœªå°±ç»ªæ—¶é™é»˜ç­‰å¾…ï¼Œé¿å… `CONNECTION_NOT_FOUND` é”™è¯¯ï¼š

```typescript
const isConnectionReady = connectionState === 'active' || connectionState === 'idle';

if (!isConnectionReady) {
  console.debug('[TransferQueue] Waiting for connection');
  return;  // ä¸æ‰§è¡Œä»»ä½• API è°ƒç”¨
}
```

---

### ğŸ“š æ–‡æ¡£æ›´æ–°

- `docs/SFTP.md`: æ–°å¢ã€Œè¿æ¥é²æ£’æ€§æ¶æ„ã€ç« èŠ‚
- `docs/ARCHITECTURE.md`: æ›´æ–° SessionTreeStore ç« èŠ‚ï¼Œè¡¥å……åŒ Store åŒæ­¥è¯´æ˜
- `docs/SYSTEM_INVARIANTS.md`: æ–°å¢ã€Œå‰ç«¯ Store é—´åŒæ­¥çº¦æŸã€ç« èŠ‚

---

### ğŸ”§ åç«¯ä¿®å¤

#### AcceptTimeout äº‹ä»¶é€šçŸ¥

WebSocket æ¥å—è¶…æ—¶æ—¶ï¼Œåç«¯ç°åœ¨æ­£ç¡®å‘é€ `connection-status-changed` äº‹ä»¶ï¼š

```rust
// src-tauri/src/commands/ssh.rs
TerminationReason::AcceptTimeout(secs) => {
    // é€šçŸ¥å‰ç«¯è¿æ¥å·²æ–­å¼€
    emit_connection_status_changed(app.clone(), &session_id, "disconnected").await;
}
```

#### è¿æ¥æ± ç»Ÿè®¡ä¿®å¤

SFTP å’Œç«¯å£è½¬å‘ç°åœ¨æ­£ç¡®æ›´æ–° `ConnectionRegistry`ï¼š

```rust
// sftp.rs - sftp_init/sftp_close
connection_registry.set_sftp_session(&connection_id, Some(session_id)).await;

// forwarding.rs - create/stop/delete_port_forward
connection_registry.add_forward(&connection_id, &forward_id).await;
connection_registry.remove_forward(&connection_id, &forward_id).await;
```

---

## ç›¸å…³ Issue

- ä¿®å¤ #TBD: SSH é‡è¿å SFTP æ ‡ç­¾é¡µå¡æ­»
- ä¿®å¤ #TBD: TransferQueue CONNECTION_NOT_FOUND é”™è¯¯

## æµ‹è¯•éªŒè¯

1. è¿æ¥ SSH â†’ æ‰“å¼€ SFTP æ ‡ç­¾é¡µ â†’ è¿›å…¥ç›®å½•
2. æ¨¡æ‹Ÿæ–­ç½‘æˆ–æœåŠ¡å™¨è¶…æ—¶
3. ç­‰å¾…/è§¦å‘é‡è¿
4. éªŒè¯ï¼š
   - `[SFTPView] Init:` æ—¥å¿—ç´§éš `[StateDrift] Auto-fixed` å‡ºç°
   - SFTP æ¢å¤åˆ°ä¹‹å‰çš„ç›®å½•
   - TransferQueue æ—  CONNECTION_NOT_FOUND é”™è¯¯
